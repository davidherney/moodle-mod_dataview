define(["jquery","core/modal_factory","core/modal_events","core/templates","core/notification","core/ajax"],function(e,t,a,n,o,i){var r=M.cfg.wwwroot,l=function(e,t){var a,n;for(var o in e)e.hasOwnProperty(o)&&(a=new RegExp("\\[\\["+o+"\\]\\]","g"),n=e[o]?e[o]:"",t=t.replace(a,n));return t};return{init:function(c){var d=e("#dataview-tpl-itemlist"),f=e("#dataview-tpl-itemsingle"),s=e(".dataview-board .records"),v=e("#dataview-tpl-createmessage"),u=null,h=null;e(".filter-box .one-filter").each(function(){var t=e(this);t.find(".filter-head").on("click",function(){t.toggleClass("opened")})}),t.create({body:v.html(),type:t.types.SAVE_CANCEL}).then(function(t){u=t,t.getModal().addClass("mod_dataview-message-modal"),t.setSaveButtonText(M.str.mod_dataview.goto),t.getRoot().on(a.save,function(){h&&e("<a>").prop({target:"_blank",href:h.attr("href")})[0].click()}),t.getRoot().on(a.hidden,function(){h=null})}),e(".filter-box .filter-btn").on("click",function(){var a=e("#fulltext-query").val(),v=[];e(".one-filter").each(function(){var t=e(this);t.find('input[type="checkbox"]:checked:enabled').each(function(){var t=e(this),a=e.trim(t.val());if(""!=a){var n={key:t.attr("name"),value:a};v.push(n)}}),t.find("select").each(function(){var t=e(this);t.find("option:selected").each(function(){var a=e.trim(e(this).val());if(""!=a){var n={key:t.attr("name"),value:a};""!=n.value&&v.push(n)}})}),t.find('input[type="text"]').each(function(){var t=e(this),a=e.trim(t.val());if(""!=a){var n={key:t.attr("name"),value:a};v.push(n)}})}),s.empty().addClass("loading"),v.forEach(e=>{e.key=e.key.replace("f_",""),e.key=e.key.replace("[]","")}),i.call([{methodname:"mod_dataview_query",args:{id:c,q:a,filters:v},done:function(a){e(".dataview-board .records").removeClass("loading"),a.forEach(a=>{var o=JSON.parse(a),i=e(l(o,d.html()));i.find('[data-operation="viewdetail"]').on("click",function(){var a=e(this),i=a.data("modal");if(i)i.show();else{var c,d=f.html();""!=d.trim()?c=l(o,d):(o.wwwroot=r,c=n.render("mod_dataview/detail",o).then(function(t,a){var n=e(t);return n.find('[data-operation="confirmgo"]').on("click",function(t){t.preventDefault(),h=e(this),u.show()}),n})),t.create({large:!0,body:c}).then(function(e){i=e,e.getModal().addClass("mod_dataview-record-modal"),e.show(),a.data("modal",i)})}}),s.append(i)})},fail:function(e){o.exception(e),console.log(e)}}])})}}});
/**
 * Javascript to initialise the block.
 *
 * @module    mod_dataview/main
 * @copyright 2020 David Herney @ BambuCo
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_dataview/main",["jquery","core/modal_factory","core/modal_events","core/templates","core/notification","core/ajax"],(function($,ModalFactory,ModalEvents,Templates,Notification,Ajax){var wwwroot=M.cfg.wwwroot,createmessagemodal=null,$currentopenlink=null,$recordsboard=null,$createmessage=null,loadrecord=function(record,template){var re,newvalue;for(var i in record)record.hasOwnProperty(i)&&(re=new RegExp("\\[\\["+i+"\\]\\]","g"),newvalue=record[i]?record[i]:"",template=template.replace(re,newvalue));return template},get_records=function(dataviewid,q,filters){var $listtemplate=$("#dataview-tpl-itemlist"),$singletemplate=$("#dataview-tpl-itemsingle");Ajax.call([{methodname:"mod_dataview_query",args:{id:dataviewid,q:q,filters:filters},done:function(data){$(".dataview-board .records").removeClass("loading"),data.forEach((element=>{var record=JSON.parse(element),$content=$(loadrecord(record,$listtemplate.html()));$content.find('[data-operation="viewdetail"]').on("click",(function(){var $open=$(this),modalresource=$open.data("modal");if(modalresource)modalresource.show();else{var detailview,tpl=$singletemplate.html();""!=tpl.trim()?detailview=loadrecord(record,tpl):(record.wwwroot=wwwroot,detailview=Templates.render("mod_dataview/detail",record).then((function(html){var $html=$(html);return $html.find('[data-operation="confirmgo"]').on("click",(function(e){e.preventDefault(),$currentopenlink=$(this),createmessagemodal.show()})),$html}))),ModalFactory.create({large:!0,body:detailview}).then((function(modal){modalresource=modal,modal.getModal().addClass("mod_dataview-record-modal"),modal.show(),$open.data("modal",modalresource)}))}})),$recordsboard.append($content)}))},fail:function(e){Notification.exception(e),console.log(e)}}])};return{init:function(dataviewid){$recordsboard=$(".dataview-board .records"),$createmessage=$("#dataview-tpl-createmessage"),$(".filter-box .one-filter").each((function(){var $_this=$(this);$_this.find(".filter-head").on("click",(function(){$_this.toggleClass("opened")}))})),ModalFactory.create({body:$createmessage.html(),type:ModalFactory.types.SAVE_CANCEL}).then((function(modal){createmessagemodal=modal,modal.getModal().addClass("mod_dataview-message-modal"),modal.setSaveButtonText(M.str.mod_dataview.goto),modal.getRoot().on(ModalEvents.save,(function(){$currentopenlink&&$("<a>").prop({target:"_blank",href:$currentopenlink.attr("href")})[0].click()})),modal.getRoot().on(ModalEvents.hidden,(function(){$currentopenlink=null}))})),$(".filter-box .search-btn").on("click",(function(){$recordsboard.empty().addClass("loading");var q=$("#fulltext-query").val();get_records(dataviewid,q,[])})),$(".filter-box .filter-btn").on("click",(function(){var filters=[];$(".one-filter").each((function(){var $one=$(this);$one.find('input[type="checkbox"]:checked:enabled').each((function(){var $control=$(this),val=$.trim($control.val());if(""!=val){var filter={key:$control.attr("name"),value:val};filters.push(filter)}})),$one.find("select").each((function(){var $control=$(this);$control.find("option:selected").each((function(){var val=$.trim($(this).val());if(""!=val){var filter={key:$control.attr("name"),value:val};""!=filter.value&&filters.push(filter)}}))})),$one.find('input[type="text"]').each((function(){var $control=$(this),val=$.trim($control.val());if(""!=val){var filter={key:$control.attr("name"),value:val};filters.push(filter)}}))})),$recordsboard.empty().addClass("loading"),filters.forEach((element=>{element.key=element.key.replace("f_",""),element.key=element.key.replace("[]","")})),get_records(dataviewid,"",filters)}))}}}));

//# sourceMappingURL=main.min.js.map
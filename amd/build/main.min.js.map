{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript to initialise the block.\n *\n * @module    mod_dataview/main\n * @copyright 2020 David Herney @ BambuCo\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/modal_factory', 'core/modal_events', 'core/templates', 'core/notification', 'core/ajax'],\nfunction ($, ModalFactory, ModalEvents, Templates, Notification, Ajax) {\n\n    var wwwroot = M.cfg.wwwroot;\n    var createmessagemodal = null;\n    var $currentopenlink = null;\n    var $recordsboard = null;\n    var $createmessage = null;\n\n    var loadrecord = function (record, template) {\n\n        var re, newvalue;\n\n        for (var i in record) {\n            if (record.hasOwnProperty(i)) {\n                re = new RegExp('\\\\[\\\\[' + i + '\\\\]\\\\]', \"g\");\n                newvalue = record[i] ? record[i] : '';\n                template = template.replace(re, newvalue);\n            }\n        }\n\n        return template;\n    };\n\n    /**\n     * Initialise all.\n     *\n     * @param {int} dataviewid The id of the dataview.\n     */\n    var init = function (dataviewid) {\n\n        $recordsboard = $('.dataview-board .records');\n        $createmessage = $('#dataview-tpl-createmessage');\n\n        $('.filter-box .one-filter').each(function() {\n            var $_this = $(this);\n            $_this.find('.filter-head').on('click', function() {\n                $_this.toggleClass('opened');\n            });\n\n        });\n\n        // Modal to display data.\n        ModalFactory.create({\n            body: $createmessage.html(),\n            type: ModalFactory.types.SAVE_CANCEL\n        })\n        .then(function(modal) {\n\n            createmessagemodal = modal;\n\n            modal.getModal().addClass('mod_dataview-message-modal');\n            modal.setSaveButtonText(M.str.mod_dataview.goto);\n\n            // Confirmation only.\n            modal.getRoot().on(ModalEvents.save, function() {\n                if ($currentopenlink) {\n                    $(\"<a>\").prop({\n                        target: \"_blank\",\n                        href: $currentopenlink.attr('href')\n                        })[0].click();\n                }\n            });\n\n            // Confirming, closing, or cancelling will destroy the modal and return focus to the trigger element.\n            modal.getRoot().on(ModalEvents.hidden, function() {\n                $currentopenlink = null;\n            });\n        });\n\n        $('.filter-box .search-btn').on('click', function () {\n\n            $recordsboard.empty().addClass('loading');\n\n            var q = $('#fulltext-query').val();\n            var sortfield = 0;\n            var sortdir = 'DESC';\n            if ($('#sortby').length > 0) {\n                sortfield = $('#sortby').val();\n                sortdir = $('#sortdirection').val();\n            }\n            var limit = parseInt($('#recordsperpage').val());\n            get_records(dataviewid, q, [], sortfield, sortdir, limit);\n\n        });\n\n        $('.filter-box .filter-btn').on('click', function () {\n\n            var filters = [];\n\n            $('.one-filter').each(function() {\n                var $one = $(this);\n                $one.find('input[type=\"checkbox\"]:checked:enabled').each(function() {\n                    var $control = $(this);\n\n                    var val = $.trim($control.val());\n                    if (val != '') {\n                        var filter = {\n                            \"key\": $control.attr('name'),\n                            \"value\": val\n                        };\n\n                        filters.push(filter);\n                    }\n                });\n\n                $one.find('select').each(function() {\n\n                    var $control = $(this);\n\n                    $control.find('option:selected').each(function() {\n                        var val = $.trim($(this).val());\n                        if (val != '') {\n                            var filter = {\n                                \"key\": $control.attr('name'),\n                                \"value\": val\n                            };\n\n                            if (filter.value != '') {\n                                filters.push(filter);\n                            }\n                        }\n                    });\n\n                });\n\n                $one.find('input[type=\"text\"]').each(function() {\n\n                    var $control = $(this);\n                    var val = $.trim($control.val());\n                    if (val != '') {\n                        var filter = {\n                            \"key\": $control.attr('name'),\n                            \"value\": val\n                        };\n\n                        filters.push(filter);\n                    }\n                });\n            });\n\n            $recordsboard.empty().addClass('loading');\n\n            // Clear special characters used by original data module.\n            filters.forEach(element => {\n                element.key = element.key.replace('f_', '');\n                element.key = element.key.replace('[]', '');\n            });\n\n            var sortfield = 0;\n            var sortdir = 'DESC';\n            if ($('#sortby').length > 0) {\n                sortfield = $('#sortby').val();\n                sortdir = $('#sortdirection').val();\n            }\n            var limit = parseInt($('#recordsperpage').val());\n            get_records(dataviewid, '', filters, sortfield, sortdir, limit);\n\n        });\n\n    };\n\n    /**\n     * Get records from the dataview.\n     *\n     * @param {int} dataviewid\n     * @param {string} q\n     * @param {object} filters\n     * @param {string} sort\n     * @param {string} dir ASC or DESC\n     * @param {int} limit\n     */\n    var get_records = function (dataviewid, q, filters, sort = 0, dir = 'DESC', limit = 0) {\n\n        var $listtemplate = $('#dataview-tpl-itemlist');\n        var $singletemplate = $('#dataview-tpl-itemsingle');\n\n        limit = limit || 0;\n\n        Ajax.call([{\n            methodname: 'mod_dataview_query',\n            args: { 'id': dataviewid, 'q': q, 'filters': filters, 'sort': sort, 'dir': dir, 'limit': limit },\n            done: function (data) {\n                $('.dataview-board .records').removeClass('loading');\n\n                data.forEach(element => {\n                    var record = JSON.parse(element);\n                    var $content = $(loadrecord(record, $listtemplate.html()));\n                    $content.find('[data-operation=\"viewdetail\"]').on('click', function() {\n                        var $open = $(this);\n                        var modalresource = $open.data('modal');\n\n                        if (modalresource) {\n                            modalresource.show();\n                            return;\n                        }\n\n                        var tpl = $singletemplate.html();\n                        var detailview;\n\n                        if (tpl.trim() != '') {\n                            detailview = loadrecord(record, tpl);\n                        } else {\n                            record.wwwroot = wwwroot;\n                            detailview = Templates.render('mod_dataview/detail', record)\n                            .then(function(html) {\n                                    var $html = $(html);\n                                    $html.find('[data-operation=\"confirmgo\"]').on('click', function(e) {\n                                        e.preventDefault();\n                                        $currentopenlink = $(this);\n                                        createmessagemodal.show();\n                                    });\n\n                                    return $html;\n                                }\n                            );\n                        }\n\n                        ModalFactory.create({\n                            large: true,\n                            body: detailview\n                        })\n                        .then(function(modal) {\n                            modalresource = modal;\n                            modal.getModal().addClass('mod_dataview-record-modal');\n                            modal.show();\n\n                            $open.data('modal', modalresource);\n                        });\n                    });\n\n                    $recordsboard.append($content);\n                });\n\n            },\n            fail: function (e) {\n                Notification.exception(e);\n                console.log(e);\n            }\n        }]);\n    };\n\n    return {\n        init: init\n    };\n});\n"],"names":["define","$","ModalFactory","ModalEvents","Templates","Notification","Ajax","wwwroot","M","cfg","createmessagemodal","$currentopenlink","$recordsboard","$createmessage","loadrecord","record","template","re","newvalue","i","hasOwnProperty","RegExp","replace","get_records","dataviewid","q","filters","sort","dir","limit","$listtemplate","$singletemplate","call","methodname","args","done","data","removeClass","forEach","element","JSON","parse","$content","html","find","on","$open","this","modalresource","show","detailview","tpl","trim","render","then","$html","e","preventDefault","create","large","body","modal","getModal","addClass","append","fail","exception","console","log","init","each","$_this","toggleClass","type","types","SAVE_CANCEL","setSaveButtonText","str","mod_dataview","goto","getRoot","save","prop","target","href","attr","click","hidden","empty","val","sortfield","sortdir","length","parseInt","$one","$control","filter","push","value","key"],"mappings":";;;;;;;AAuBAA,2BAAO,CAAC,SAAU,qBAAsB,oBAAqB,iBAAkB,oBAAqB,cACpG,SAAUC,EAAGC,aAAcC,YAAaC,UAAWC,aAAcC,UAEzDC,QAAUC,EAAEC,IAAIF,QAChBG,mBAAqB,KACrBC,iBAAmB,KACnBC,cAAgB,KAChBC,eAAiB,KAEjBC,WAAa,SAAUC,OAAQC,cAE3BC,GAAIC,aAEH,IAAIC,KAAKJ,OACNA,OAAOK,eAAeD,KACtBF,GAAK,IAAII,OAAO,SAAWF,EAAI,SAAU,KACzCD,SAAWH,OAAOI,GAAKJ,OAAOI,GAAK,GACnCH,SAAWA,SAASM,QAAQL,GAAIC,kBAIjCF,UAuJPO,YAAc,SAAUC,WAAYC,EAAGC,aAASC,4DAAO,EAAGC,2DAAM,OAAQC,6DAAQ,MAE5EC,cAAgB7B,EAAE,0BAClB8B,gBAAkB9B,EAAE,4BAExB4B,MAAQA,OAAS,EAEjBvB,KAAK0B,KAAK,CAAC,CACPC,WAAY,qBACZC,KAAM,IAAQV,aAAiBC,UAAcC,aAAiBC,SAAaC,UAAcC,OACzFM,KAAM,SAAUC,MACZnC,EAAE,4BAA4BoC,YAAY,WAE1CD,KAAKE,SAAQC,cACLxB,OAASyB,KAAKC,MAAMF,SACpBG,SAAWzC,EAAEa,WAAWC,OAAQe,cAAca,SAClDD,SAASE,KAAK,iCAAiCC,GAAG,SAAS,eACnDC,MAAQ7C,EAAE8C,MACVC,cAAgBF,MAAMV,KAAK,YAE3BY,cACAA,cAAcC,gBAKdC,WADAC,IAAMpB,gBAAgBY,OAGR,IAAdQ,IAAIC,OACJF,WAAapC,WAAWC,OAAQoC,MAEhCpC,OAAOR,QAAUA,QACjB2C,WAAa9C,UAAUiD,OAAO,sBAAuBtC,QACpDuC,MAAK,SAASX,UACHY,MAAQtD,EAAE0C,aACdY,MAAMX,KAAK,gCAAgCC,GAAG,SAAS,SAASW,GAC5DA,EAAEC,iBACF9C,iBAAmBV,EAAE8C,MACrBrC,mBAAmBuC,UAGhBM,UAKnBrD,aAAawD,OAAO,CAChBC,OAAO,EACPC,KAAMV,aAETI,MAAK,SAASO,OACXb,cAAgBa,MAChBA,MAAMC,WAAWC,SAAS,6BAC1BF,MAAMZ,OAENH,MAAMV,KAAK,QAASY,sBAI5BpC,cAAcoD,OAAOtB,cAI7BuB,KAAM,SAAUT,GACZnD,aAAa6D,UAAUV,GACvBW,QAAQC,IAAIZ,cAKjB,CACHa,KAtNO,SAAU7C,YAEjBZ,cAAgBX,EAAE,4BAClBY,eAAiBZ,EAAE,+BAEnBA,EAAE,2BAA2BqE,MAAK,eAC1BC,OAAStE,EAAE8C,MACfwB,OAAO3B,KAAK,gBAAgBC,GAAG,SAAS,WACpC0B,OAAOC,YAAY,gBAM3BtE,aAAawD,OAAO,CAChBE,KAAM/C,eAAe8B,OACrB8B,KAAMvE,aAAawE,MAAMC,cAE5BrB,MAAK,SAASO,OAEXnD,mBAAqBmD,MAErBA,MAAMC,WAAWC,SAAS,8BAC1BF,MAAMe,kBAAkBpE,EAAEqE,IAAIC,aAAaC,MAG3ClB,MAAMmB,UAAUnC,GAAG1C,YAAY8E,MAAM,WAC7BtE,kBACAV,EAAE,OAAOiF,KAAK,CACVC,OAAQ,SACRC,KAAMzE,iBAAiB0E,KAAK,UACzB,GAAGC,WAKlBzB,MAAMmB,UAAUnC,GAAG1C,YAAYoF,QAAQ,WACnC5E,iBAAmB,WAI3BV,EAAE,2BAA2B4C,GAAG,SAAS,WAErCjC,cAAc4E,QAAQzB,SAAS,eAE3BtC,EAAIxB,EAAE,mBAAmBwF,MACzBC,UAAY,EACZC,QAAU,OACV1F,EAAE,WAAW2F,OAAS,IACtBF,UAAYzF,EAAE,WAAWwF,MACzBE,QAAU1F,EAAE,kBAAkBwF,WAE9B5D,MAAQgE,SAAS5F,EAAE,mBAAmBwF,OAC1ClE,YAAYC,WAAYC,EAAG,GAAIiE,UAAWC,QAAS9D,UAIvD5B,EAAE,2BAA2B4C,GAAG,SAAS,eAEjCnB,QAAU,GAEdzB,EAAE,eAAeqE,MAAK,eACdwB,KAAO7F,EAAE8C,MACb+C,KAAKlD,KAAK,0CAA0C0B,MAAK,eACjDyB,SAAW9F,EAAE8C,MAEb0C,IAAMxF,EAAEmD,KAAK2C,SAASN,UACf,IAAPA,IAAW,KACPO,OAAS,KACFD,SAASV,KAAK,cACZI,KAGb/D,QAAQuE,KAAKD,YAIrBF,KAAKlD,KAAK,UAAU0B,MAAK,eAEjByB,SAAW9F,EAAE8C,MAEjBgD,SAASnD,KAAK,mBAAmB0B,MAAK,eAC9BmB,IAAMxF,EAAEmD,KAAKnD,EAAE8C,MAAM0C,UACd,IAAPA,IAAW,KACPO,OAAS,KACFD,SAASV,KAAK,cACZI,KAGO,IAAhBO,OAAOE,OACPxE,QAAQuE,KAAKD,eAO7BF,KAAKlD,KAAK,sBAAsB0B,MAAK,eAE7ByB,SAAW9F,EAAE8C,MACb0C,IAAMxF,EAAEmD,KAAK2C,SAASN,UACf,IAAPA,IAAW,KACPO,OAAS,KACFD,SAASV,KAAK,cACZI,KAGb/D,QAAQuE,KAAKD,eAKzBpF,cAAc4E,QAAQzB,SAAS,WAG/BrC,QAAQY,SAAQC,UACZA,QAAQ4D,IAAM5D,QAAQ4D,IAAI7E,QAAQ,KAAM,IACxCiB,QAAQ4D,IAAM5D,QAAQ4D,IAAI7E,QAAQ,KAAM,WAGxCoE,UAAY,EACZC,QAAU,OACV1F,EAAE,WAAW2F,OAAS,IACtBF,UAAYzF,EAAE,WAAWwF,MACzBE,QAAU1F,EAAE,kBAAkBwF,WAE9B5D,MAAQgE,SAAS5F,EAAE,mBAAmBwF,OAC1ClE,YAAYC,WAAY,GAAIE,QAASgE,UAAWC,QAAS9D"}